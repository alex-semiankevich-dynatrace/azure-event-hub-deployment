{
  "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json#",
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": false,
      "basics": {
        "description": "Deploy Event Hub namespaces across multiple Azure locations for Dynatrace log and event ingestion.",
        "subscription": {
          "resourceProviders": [
            "Microsoft.EventHub",
            "Microsoft.Authorization"
          ]
        },
        "resourceGroup": {
          "visible": false
        },
        "location": {
          "visible": true,
          "label": "Location",
          "toolTip": "Location for storing deployment metadata only. This is not used for Event Hub deployment. Select deployment regions in the next step."
        }
      }
    },
    "basics": [],
    "steps": [
      {
        "name": "dynatraceConfig",
        "label": "Dynatrace Configuration",
        "elements": [
          {
            "name": "dynatraceInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Provide your Dynatrace tenant and monitoring configuration details. Select the service principal used for Dynatrace monitoring"
            }
          },
          {
            "name": "dtTenantId",
            "type": "Microsoft.Common.TextBox",
            "label": "Dynatrace Tenant ID",
            "toolTip": "Your Dynatrace tenant identifier (e.g. abc12345)",
            "constraints": {
              "required": true
            }
          },
          {
            "name": "dtConfigId",
            "type": "Microsoft.Common.TextBox",
            "label": "Monitoring Configuration ID",
            "toolTip": "Dynatrace monitoring configuration ID (UUID format)",
            "constraints": {
              "required": true,
              "regex": "^[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}$",
              "validationMessage": "Must be a valid UUID (e.g., 592b6da9-9ce2-4ead-9e24-55bdae3bfaf7)"
            }
          },
          {
            "name": "environment",
            "type": "Microsoft.Common.DropDown",
            "label": "Environment",
            "toolTip": "Target environment for deployment",
            "defaultValue": "Production",
            "constraints": {
              "required": true,
              "allowedValues": [
                {
                  "label": "Production",
                  "value": "prod"
                },
                {
                  "label": "Development",
                  "value": "dev"
                },
                {
                  "label": "Test",
                  "value": "test"
                }
              ]
            }
          },
          {
            "name": "ServicePrincipal",
            "type": "Microsoft.Common.ServicePrincipalSelector",
            "label": {
              "principalId": "Service Principal ID",
              "password": "Secret key",
              "sectionHeader": "Select Dynatrace Service Principal"
            },
            "defaultValue": {
              "principalId": "<default guid>",
              "name": "(New) default App Id"
            },
            "constraints": {
              "required": true
            },
            "options": {
              "hideCertificate": true
            }
          }
        ]
      },
      {
        "name": "eventHubNamespaceConfig",
        "label": "Event Hub Namespace Configuration",
        "elements": [
          {
            "name": "namespaceInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Configure the Event Hub namespace SKU, capacity, and auto-inflate settings. Auto-inflate automatically scales throughput units based on load."
            }
          },
          {
            "name": "locationsApi",
            "type": "Microsoft.Solutions.ArmApiControl",
            "request": {
              "method": "GET",
              "path": "[concat(subscription().id, '/locations?api-version=2022-12-01')]"
            }
          },
          {
            "name": "locations",
            "type": "Microsoft.Common.DropDown",
            "label": "Regions",
            "toolTip": "Select one or more regions to deploy Event Hub Namespaces.",
            "multiselect": true,
            "filter": true,
            "constraints": {
              "allowedValues": "[map(steps('eventHubNamespaceConfig').locationsApi.value, (item) => parse(concat('{\"label\":\"', item.displayName, '\",\"value\":\"', item.name, '\"}')))]",
              "required": true
            },
            "visible": true
          },
          {
            "name": "skuName",
            "type": "Microsoft.Common.DropDown",
            "label": "SKU",
            "toolTip": "Event Hub namespace pricing tier",
            "defaultValue": "Standard",
            "constraints": {
              "required": true,
              "allowedValues": [
                {
                  "label": "Basic",
                  "value": "Basic"
                },
                {
                  "label": "Standard",
                  "value": "Standard"
                },
                {
                  "label": "Premium",
                  "value": "Premium"
                }
              ]
            }
          },
          {
            "name": "skuCapacity",
            "type": "Microsoft.Common.Slider",
            "label": "Throughput Units (Baseline)",
            "min": 1,
            "max": 20,
            "defaultValue": 1,
            "showStepMarkers": false,
            "toolTip": "Minimum/baseline throughput units (1-20). This is the starting capacity before auto-inflate.",
            "constraints": {
              "required": true
            },
            "visible": true
          },
          {
            "name": "maximumThroughputUnits",
            "type": "Microsoft.Common.Slider",
            "label": "Maximum Throughput Units (Auto-inflate)",
            "min": "[steps('eventHubNamespaceConfig').skuCapacity]",
            "max": 40,
            "defaultValue": 10,
            "showStepMarkers": false,
            "toolTip": "Maximum throughput units for auto-inflate scaling (1-40). Must be greater than or equal to baseline throughput units.",
            "constraints": {
              "required": true
            },
            "visible": "[equals(steps('eventHubNamespaceConfig').skuName, 'Standard')]"
          },
          {
            "name": "zoneRedundant",
            "type": "Microsoft.Common.CheckBox",
            "label": "Enable Zone Redundancy",
            "toolTip": "Requires Standard or Premium SKU. Provides high availability across availability zones.",
            "visible": "[or(equals(steps('eventHubNamespaceConfig').skuName, 'Standard'), equals(steps('eventHubNamespaceConfig').skuName, 'Premium'))]"
          }
        ]
      },
      {
        "name": "eventHubConfig",
        "label": "Event Hub Settings",
        "elements": [
          {
            "name": "eventHubInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Configure partition counts and message retention for the dt-logs-evh and dt-events-evh Event Hubs that will be created in each namespace."
            }
          },
          {
            "name": "logsEventHubSection",
            "type": "Microsoft.Common.Section",
            "label": "Logs Event Hub Configuration",
            "elements": [
              {
                "name": "evhLogsPartitionCount",
                "type": "Microsoft.Common.TextBox",
                "label": "Partition Count",
                "defaultValue": "4",
                "toolTip": "Number of partitions (1-32)",
                "constraints": {
                  "required": true,
                  "regex": "^([1-9]|[1-2][0-9]|3[0-2])$",
                  "validationMessage": "Must be a number between 1 and 32"
                }
              },
              {
                "name": "evhLogsRetentionInDays",
                "type": "Microsoft.Common.Slider",
                "label": "Message Retention (days)",
                "min": 1,
                "max": 7,
                "defaultValue": 1,
                "showStepMarkers": true,
                "toolTip": "Number of days to retain log messages (1-7)",
                "constraints": {
                  "required": true
                }
              }
            ],
            "visible": true
          },
          {
            "name": "eventsEventHubSection",
            "type": "Microsoft.Common.Section",
            "label": "Events Event Hub Configuration",
            "elements": [
              {
                "name": "evhEventsPartitionCount",
                "type": "Microsoft.Common.DropDown",
                "label": "Partition Count",
                "toolTip": "Number of partitions (1 or 2)",
                "defaultValue": "1",
                "constraints": {
                  "required": true,
                  "allowedValues": [
                    {
                      "label": "1",
                      "value": "1"
                    },
                    {
                      "label": "2",
                      "value": "2"
                    }
                  ]
                }
              },
              {
                "name": "evhEventsRetentionInDays",
                "type": "Microsoft.Common.Slider",
                "label": "Message Retention (days)",
                "min": 1,
                "max": 7,
                "defaultValue": 1,
                "showStepMarkers": true,
                "toolTip": "Number of days to retain event messages (1-7)",
                "constraints": {
                  "required": true
                }
              }
            ],
            "visible": true
          }
        ]
      },
      {
        "name": "tags",
        "label": "Tags",
        "elements": [
          {
            "name": "tagsInfo",
            "type": "Microsoft.Common.InfoBox",
            "visible": true,
            "options": {
              "icon": "Info",
              "text": "Optional: Add custom tags to all deployed resources. Standard tags (environment, managed-by, dt-log-ingest-activated) are added automatically."
            }
          },
          {
            "name": "customTags",
            "type": "Microsoft.Common.TagsByResource",
            "toolTip": "Add custom tags to resources",
            "resources": [
              "Microsoft.EventHub/namespaces",
              "Microsoft.Resources/resourceGroups"
            ]
          }
        ]
      }
    ],
    "outputs": {
      "locations": "[steps('eventHubNamespaceConfig').locations]",
      "dtTenantId": "[steps('dynatraceConfig').dtTenantId]",
      "dtConfigId": "[steps('dynatraceConfig').dtConfigId]",
      "environment": "[steps('dynatraceConfig').environment]",
      "dtMonitoringServicePrincipalId": "[first(steps('dynatraceConfig').ServicePrincipal.objectId)]",
      "skuName": "[steps('eventHubNamespaceConfig').skuName]",
      "skuCapacity": "[steps('eventHubNamespaceConfig').skuCapacity]",
      "maximumThroughputUnits": "[steps('eventHubNamespaceConfig').maximumThroughputUnits]",
      "zoneRedundant": "[steps('eventHubNamespaceConfig').zoneRedundant]",
      "evhLogsPartitionCount": "[int(steps('eventHubConfig').logsEventHubSection.evhLogsPartitionCount)]",
      "evhLogsRetentionInDays": "[steps('eventHubConfig').logsEventHubSection.evhLogsRetentionInDays]",
      "evhEventsPartitionCount": "[int(steps('eventHubConfig').eventsEventHubSection.evhEventsPartitionCount)]",
      "evhEventsRetentionInDays": "[steps('eventHubConfig').eventsEventHubSection.evhEventsRetentionInDays]",
      "tags": "[steps('tags').customTags]"
    }
  }
}